# ==========================================
# SECURITY CONFIGURATION FILE
# Handles security headers and protections
# ==========================================

RewriteEngine On

# ==========================================
# SECURITY HEADERS
# ==========================================

<IfModule mod_headers.c>
    # Content Security Policy (CSP)
    # Strict policy - all scripts must be from same origin
    # MUST use 'always' to apply to error pages and static files
    Header always set Content-Security-Policy "default-src 'self'; script-src 'self'; style-src 'self'; img-src 'self' data:; font-src 'self'; connect-src 'self'; frame-ancestors 'none'; base-uri 'self'; form-action 'self'; object-src 'none';"
    
    # X-Content-Type-Options
    # Prevents MIME type sniffing
    Header always set X-Content-Type-Options "nosniff"
    
    # X-Frame-Options
    # Prevents clickjacking attacks
    Header always set X-Frame-Options "DENY"
    
    # X-XSS-Protection
    # Enables XSS filtering
    Header always set X-XSS-Protection "1; mode=block"
    
    # Referrer-Policy
    # Controls referrer information
    Header always set Referrer-Policy "strict-origin-when-cross-origin"
    
    # Permissions-Policy
    # Controls browser features
    Header always set Permissions-Policy "geolocation=(), microphone=(), camera=(), payment=()"
    
    # Remove server information headers
    Header always unset X-Powered-By
    Header unset X-Powered-By
    Header always unset Server
</IfModule>

# ==========================================
# COOKIE SECURITY
# ==========================================

<IfModule mod_php7.c>
    php_flag session.cookie_httponly On
    php_flag session.cookie_secure Off
    php_value session.cookie_samesite Lax
</IfModule>

# ==========================================
# HIDE SERVER VERSION INFORMATION
# ==========================================

ServerSignature Off

# ==========================================
# DISABLE DIRECTORY BROWSING
# ==========================================

Options -Indexes

# ==========================================
# PROTECT SENSITIVE FILES
# ==========================================

<FilesMatch "\.(ini|log|sh|sql|md)$">
    Order allow,deny
    Deny from all
</FilesMatch>

<Files .htaccess>
    Order allow,deny
    Deny from all
</Files>

# ==========================================
# URL REWRITING (EXISTING RULES)
# ==========================================

# /index edo /index.php-ra sartzen bada, /-era birbideratu
RewriteCond %{THE_REQUEST} /index(\.php)? [NC]
RewriteRule ^index(\.php)?$ / [R=301,L]

# Beste PHP fitxategien luzapena ezkutatu (.php ez ikusi URL-an)
RewriteCond %{THE_REQUEST} \s/([^\s]+?)\.php[?\s] [NC]
RewriteRule ^ /%1 [R=301,L]

# URL garbiak .php fitxategietara birbideratu
RewriteCond %{REQUEST_FILENAME} !-f
RewriteCond %{REQUEST_FILENAME} !-d
RewriteCond %{REQUEST_FILENAME}.php -f
RewriteRule ^(.*)$ $1.php [L]
